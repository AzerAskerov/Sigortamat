using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Text.Json;
using System.Threading.Tasks;

namespace SigortaYoxla
{
    public class WhatsAppService
    {
        private readonly string _whatsappBotPath;
        
        public WhatsAppService()
        {
            // WhatsApp bot qovluÄŸunun yolu
            _whatsappBotPath = Path.Combine(Directory.GetCurrentDirectory(), "whatsapp-bot");
        }

        /// <summary>
        /// TÉ™k WhatsApp mesajÄ± gÃ¶ndÉ™rir
        /// </summary>
        public async Task<bool> SendMessageAsync(string phoneNumber, string message)
        {
            try
            {
                Console.WriteLine($"ğŸ“± WhatsApp mesajÄ± gÃ¶ndÉ™rilir: {phoneNumber}");
                
                var processInfo = new ProcessStartInfo
                {
                    FileName = "node",
                    Arguments = $"whatsapp-sender.js send {phoneNumber} \"{message}\"",
                    WorkingDirectory = _whatsappBotPath,
                    RedirectStandardOutput = true,
                    RedirectStandardError = true,
                    UseShellExecute = false,
                    CreateNoWindow = true
                };

                using var process = Process.Start(processInfo);
                if (process == null)
                {
                    Console.WriteLine("âŒ WhatsApp prosesi baÅŸlamadÄ±");
                    return false;
                }
                
                await process.WaitForExitAsync();
                
                var output = await process.StandardOutput.ReadToEndAsync();
                var error = await process.StandardError.ReadToEndAsync();
                
                if (process.ExitCode == 0)
                {
                    Console.WriteLine($"âœ… WhatsApp mesajÄ± gÃ¶ndÉ™rildi: {phoneNumber}");
                    return true;
                }
                else
                {
                    Console.WriteLine($"âŒ WhatsApp mesajÄ± gÃ¶ndÉ™rilmÉ™di: {error}");
                    return false;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"âŒ WhatsApp xÉ™tasÄ±: {ex.Message}");
                return false;
            }
        }

        /// <summary>
        /// Bulk WhatsApp mesajlarÄ± gÃ¶ndÉ™rir
        /// </summary>
        public async Task<bool> SendBulkMessagesAsync(List<WhatsAppMessage> messages)
        {
            try
            {
                // MÃ¼vÉ™qqÉ™ti JSON faylÄ± yaradÄ±rÄ±q
                var tempJsonFile = Path.Combine(_whatsappBotPath, $"temp_messages_{DateTime.Now:yyyyMMdd_HHmmss}.json");
                
                var jsonContent = JsonSerializer.Serialize(messages, new JsonSerializerOptions 
                { 
                    PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
                    WriteIndented = true 
                });
                
                await File.WriteAllTextAsync(tempJsonFile, jsonContent);
                
                Console.WriteLine($"ğŸ“¦ {messages.Count} WhatsApp mesajÄ± gÃ¶ndÉ™rilir...");
                
                var processInfo = new ProcessStartInfo
                {
                    FileName = "node",
                    Arguments = $"whatsapp-sender.js bulk \"{tempJsonFile}\"",
                    WorkingDirectory = _whatsappBotPath,
                    RedirectStandardOutput = true,
                    RedirectStandardError = true,
                    UseShellExecute = false,
                    CreateNoWindow = true
                };

                using var process = Process.Start(processInfo);
                if (process == null)
                {
                    Console.WriteLine("âŒ WhatsApp bulk prosesi baÅŸlamadÄ±");
                    return false;
                }
                
                await process.WaitForExitAsync();
                
                var output = await process.StandardOutput.ReadToEndAsync();
                var error = await process.StandardError.ReadToEndAsync();
                
                // MÃ¼vÉ™qqÉ™ti faylÄ± silirik
                if (File.Exists(tempJsonFile))
                {
                    File.Delete(tempJsonFile);
                }
                
                if (process.ExitCode == 0)
                {
                    Console.WriteLine($"âœ… Bulk WhatsApp mesajlarÄ± gÃ¶ndÉ™rildi!");
                    Console.WriteLine(output);
                    return true;
                }
                else
                {
                    Console.WriteLine($"âŒ Bulk WhatsApp mesajlarÄ± gÃ¶ndÉ™rilmÉ™di: {error}");
                    return false;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"âŒ Bulk WhatsApp xÉ™tasÄ±: {ex.Message}");
                return false;
            }
        }

        /// <summary>
        /// WhatsApp bot hazÄ±rlÄ±q vÉ™ziyyÉ™tini yoxlayÄ±r
        /// </summary>
        public async Task<bool> IsWhatsAppReadyAsync()
        {
            try
            {
                var processInfo = new ProcessStartInfo
                {
                    FileName = "node",
                    Arguments = "whatsapp-sender.js test",
                    WorkingDirectory = _whatsappBotPath,
                    RedirectStandardOutput = true,
                    RedirectStandardError = true,
                    UseShellExecute = false,
                    CreateNoWindow = true
                };

                using var process = Process.Start(processInfo);
                if (process == null)
                {
                    return false;
                }
                
                await process.WaitForExitAsync();
                
                return process.ExitCode == 0;
            }
            catch
            {
                return false;
            }
        }

        /// <summary>
        /// SÄ±ÄŸorta nÉ™ticÉ™sinÉ™ É™sasÉ™n WhatsApp mesajÄ± formatlayÄ±r
        /// </summary>
        public static string FormatInsuranceMessage(string carNumber, string insuranceResult)
        {
            var timestamp = DateTime.Now.ToString("dd.MM.yyyy HH:mm");
            
            return $@"ğŸš— Avtomobil SÄ±ÄŸorta MÉ™lumatlarÄ±

ğŸ“‹ NÃ¶mrÉ™: {carNumber}
ğŸ“… Yoxlanma tarixi: {timestamp}

{insuranceResult}

â„¹ï¸ Bu mÉ™lumat SigortaYoxla sistemi tÉ™rÉ™findÉ™n avtomatik olaraq É™ldÉ™ edilmiÅŸdir.

TÉ™ÅŸÉ™kkÃ¼rlÉ™r! ğŸ™";
        }
    }

    /// <summary>
    /// WhatsApp mesajÄ± strukturu
    /// </summary>
    public class WhatsAppMessage
    {
        public string PhoneNumber { get; set; } = "";
        public string Message { get; set; } = "";
    }
}
